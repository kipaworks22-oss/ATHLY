import React, { useEffect, useMemo, useState } from "react";
const STORAGE_KEY = "athly-kbo-selfcare-v1";
const CFG = (typeof window !== "undefined" && window.ATHLY_CONFIG) || { BACKEND_BASE: "" };
const BACKEND = CFG.BACKEND_BASE;
function usePersistentState(defaultValue){const[s,setS]=useState(()=>{try{const r=localStorage.getItem(STORAGE_KEY);return r?JSON.parse(r):defaultValue}catch{return defaultValue}});useEffect(()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(s)),[s]);return[s,setS]}
const todayISO=()=>new Date().toISOString().slice(0,10);
function Section({title,subtitle,children,right}){return(<div className="bg-white rounded-2xl shadow p-5 mb-6"><div className="flex items-start justify-between mb-3"><div><h2 className="text-xl font-semibold">{title}</h2>{subtitle&&<p className="text-sm text-gray-500 mt-1">{subtitle}</p>}</div>{right}</div>{children}</div>);}
function Input({label,...props}){return(<label className="block mb-3"><span className="block text-sm text-gray-600 mb-1">{label}</span><input className="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/10"{...props}/></label>);}
function Textarea({label,...props}){return(<label className="block mb-3"><span className="block text-sm text-gray-600 mb-1">{label}</span><textarea className="w-full border rounded-xl px-3 py-2 min-h-[88px] focus:outline-none focus:ring-2 focus:ring-black/10"{...props}/></label>);}
function Select({label,options,...props}){return(<label className="block mb-3"><span className="block text-sm text-gray-600 mb-1">{label}</span><select className="w-full border rounded-xl px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-black/10"{...props}>{options.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}</select></label>);}
function PillButton({children,...props}){return(<button className="px-3 py-2 rounded-full bg-black text-white text-sm hover:opacity-90 active:opacity-80 disabled:opacity-50"{...props}>{children}</button>);}
function Row({children}){return <div className="grid grid-cols-1 md:grid-cols-2 gap-3">{children}</div>}
export default function App(){const[db,setDb]=usePersistentState({linkedPlayer:null,bullpen:[],workouts:[],games:[]});const[tab,setTab]=useState("home");return(<div className="min-h-screen bg-gray-50 text-gray-900"><header className="max-w-3xl mx-auto px-4 pt-8 pb-4"><div className="flex items-center justify-between"><div><h1 className="text-2xl font-bold">ATHLY β</h1><p className="text-sm text-gray-500">KBO 연동 베타 · Asia/Seoul</p>{db.linkedPlayer?(<p className="text-sm mt-1">연결된 선수: <b>{db.linkedPlayer.name}</b> ({db.linkedPlayer.team}) · ID: {db.linkedPlayer.id}</p>):(<p className="text-sm mt-1 text-red-600">아직 KBO 선수 연결이 필요해요.</p>)}</div><div className="flex gap-2"><PillButton onClick={()=>setTab("kbo")}>선수 연결</PillButton></div></div><nav className="mt-6 flex gap-2 flex-wrap">{[{k:"home",l:"홈"},{k:"game",l:"경기기록"},{k:"bullpen",l:"불펜"},{k:"workout",l:"운동"},{k:"report",l:"리포트"},{k:"kbo",l:"KBO연동"}].map(t=>(<button key={t.k} onClick={()=>setTab(t.k)} className={`px-4 py-2 rounded-full text-sm ${tab===t.k?"bg-black text-white":"bg-white text-gray-700 border"}`}>{t.l}</button>))}</nav></header><main className="max-w-3xl mx-auto px-4 pb-16">{tab==="home"&&<Home db={db}/>} {tab==="game"&&<GameLog db={db} setDb={setDb}/>} {tab==="bullpen"&&<Bullpen db={db} setDb={setDb}/>} {tab==="workout"&&<Workout db={db} setDb={setDb}/>} {tab==="report"&&<Report db={db}/>} {tab==="kbo"&&<KboLink db={db} setDb={setDb}/>}</main></div>);}
function Home({db}){return(<><Section title="시작하기" subtitle="선수 연결 후 자동 동기화를 쓸 수 있어요.">{db.linkedPlayer?(<div className="text-sm"><p>연결된 선수의 경기/박스스코어를 동기화하려면 아래 버튼을 눌러보세요.</p><div className="mt-2 flex gap-2"><SyncButtons db={db}/></div></div>):(<p className="text-sm text-gray-600">상단의 <b>선수 연결</b>을 먼저 완료해주세요.</p>)}</Section></>);}
function SyncButtons({db}){const[msg,setMsg]=useState("");const sync=async(scope)=>{if(!db.linkedPlayer)return;setMsg("동기화 중...");try{if(!BACKEND){await new Promise(r=>setTimeout(r,500));setMsg("데모: 오늘 경기 1건, 이벤트 5개를 불러온 것으로 처리됨.");return;}const url=`${BACKEND}/kbo/sync?playerId=${encodeURIComponent(db.linkedPlayer.id)}&scope=${scope}`;const res=await fetch(url);const data=await res.json();setMsg(`동기화 완료: ${data.message||"ok"}`);}catch(e){setMsg("동기화 실패: "+e.message)}};return(<div className="text-sm"><div className="flex gap-2"><PillButton onClick={()=>sync("today")}>오늘 경기 동기화</PillButton><PillButton onClick={()=>sync("recent")}>최근 경기 동기화</PillButton></div>{msg&&<p className="text-gray-600 mt-2">{msg}</p>}</div>);}
function KboLink({db,setDb}){const[q,setQ]=useState("");const[loading,setLoading]=useState(false);const[results,setResults]=useState([]);const[err,setErr]=useState("");const search=async()=>{setLoading(true);setErr("");setResults([]);try{if(!BACKEND){const sample=[{id:"70001",name:"김성민",team:"키움 히어로즈",position:"투수"},{id:"70002",name:"이정후",team:"KBO 샘플",position:"외야수"},{id:"70003",name:"안우진",team:"키움 히어로즈",position:"투수"}].filter(p=>p.name.includes(q));await new Promise(r=>setTimeout(r,400));setResults(sample);}else{const res=await fetch(`${BACKEND}/kbo/search?name=${encodeURIComponent(q)}`);if(!res.ok)throw new Error("검색 실패");const data=await res.json();setResults(data.players||[]);}}catch(e){setErr(e.message)}finally{setLoading(false)}};const link=(p)=>{setDb({...db,linkedPlayer:p})};return(<Section title="KBO 선수 연결" subtitle="선수 이름으로 검색하고 선택하면 연결됩니다."><div className="flex gap-2"><input className="flex-1 border rounded-xl px-3 py-2" placeholder="예: 김성민" value={q} onChange={e=>setQ(e.target.value)}/><PillButton onClick={search} disabled={!q||loading}>{loading?"검색 중...":"검색"}</PillButton></div>{err&&<p className="text-sm text-red-600 mt-2">{err}</p>}<div className="mt-4 space-y-2">{results.map((p,i)=>(<div key={i} className="bg-gray-100 rounded-xl p-3 flex items-center justify-between"><div className="text-sm"><div className="font-medium">{p.name}</div><div className="text-gray-600">{p.team} · {p.position} · ID {p.id}</div></div><PillButton onClick={()=>link(p)}>선택</PillButton></div>))}{!loading&&results.length===0&&<p className="text-sm text-gray-500">검색 결과가 여기에 표시됩니다.</p>}</div><hr className="my-6"/><p className="text-xs text-gray-500">백엔드가 설정되어 있지 않으면 <b>데모 모드</b>로 동작합니다. 실제 KBO 연동을 하려면 <code>config.js</code>에 백엔드 주소를 넣어주세요.</p></Section>);}
function GameLog({db,setDb}){const[form,setForm]=useState({date:todayISO(),opponent:"",homeAway:"H",usedInningFrom:"",usedInningTo:"",pitches:"",notes:""});const add=()=>{const payload={...form,pitches:Number(form.pitches||0)};setDb({...db,games:[...db.games,payload]});setForm({...form,opponent:"",usedInningFrom:"",usedInningTo:"",pitches:"",notes:""})};return(<><Section title="경기 사용 기록" subtitle="당일 어떻게 쓰였는지 간단 요약"><Row><Input label="날짜" type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})}/><Input label="상대팀" placeholder="예: LG" value={form.opponent} onChange={e=>setForm({...form,opponent:e.target.value})}/><Select label="홈/원정" value={form.homeAway} onChange={e=>setForm({...form,homeAway:e.target.value})} options={[{value:"H",label:"홈"},{value:"A",label:"원정"}]}/><Input label="등판 이닝(시작)" placeholder="예: 7" value={form.usedInningFrom} onChange={e=>setForm({...form,usedInningFrom:e.target.value})}/><Input label="등판 이닝(끝)" placeholder="예: 7" value={form.usedInningTo} onChange={e=>setForm({...form,usedInningTo:e.target.value})}/><Input label="투구수(구)" type="number" placeholder="예: 22" value={form.pitches} onChange={e=>setForm({...form,pitches:e.target.value})}/><Textarea label="메모(대타/대타자/상황 등)" placeholder="주자상황, 타자, 결과 요약" value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})}/></Row><div className="flex justify-end"><PillButton onClick={add}>저장</PillButton></div></Section><Section title="기록 목록"><div className="space-y-3">{db.games.slice().sort((a,b)=>a.date<b.date?1:-1).map((g,i)=>(<div key={i} className="bg-white border rounded-xl p-4"><div className="flex items-center justify-between"><div className="font-medium">{g.date} · {g.homeAway==="H"?"홈":"원정"} vs {g.opponent}</div><div className="text-sm text-gray-500">{g.pitches}구</div></div>{g.notes&&<p className="text-sm text-gray-700 mt-2">{g.notes}</p>}</div>))}</div></Section></>);}
function Bullpen({db,setDb}){const[form,setForm]=useState({date:todayISO(),context:"경기 전",startTime:"",totalPitches:"",intensityRPE:"5",mix:"직구/슬라이더/체인지업",notes:""});const add=()=>{setDb({...db,bullpen:[...db.bullpen,{...form,totalPitches:Number(form.totalPitches||0),intensityRPE:Number(form.intensityRPE||0)}]});setForm({...form,startTime:"",totalPitches:"",notes:""})};return(<><Section title="불펜 기록" subtitle="팔 풀었는지/언제/강도/구종 비율"><Row><Input label="날짜" type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})}/><Select label="상황" value={form.context} onChange={e=>setForm({...form,context:e.target.value})} options={[{value:"경기 전",label:"경기 전"},{value:"경기 중",label:"경기 중"},{value:"경기 후",label:"경기 후"},{value:"훈련",label:"훈련"}]}/><Input label="시작 시간" placeholder="예: 18:20" value={form.startTime} onChange={e=>setForm({...form,startTime:e.target.value})}/><Input label="총 투구수(구)" type="number" placeholder="예: 30" value={form.totalPitches} onChange={e=>setForm({...form,totalPitches:e.target.value})}/><Input label="강도(RPE 1-10)" type="number" value={form.intensityRPE} onChange={e=>setForm({...form,intensityRPE:e.target.value})}/><Input label="구종 비율 메모" placeholder="예: 직50 슬30 체20" value={form.mix} onChange={e=>setForm({...form,mix:e.target.value})}/><Textarea label="메모" placeholder="캐처/장소/느낌 등" value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})}/></Row><div className="flex justify-end"><PillButton onClick={add}>저장</PillButton></div></Section><Section title="기록 목록"><div className="space-y-3">{db.bullpen.slice().sort((a,b)=>a.date<b.date?1:-1).map((b,i)=>(<div key={i} className="bg-white border rounded-xl p-4"><div className="flex items-center justify-between"><div className="font-medium">{b.date} · {b.context}</div><div className="text-sm text-gray-500">{b.totalPitches}구 · RPE{b.intensityRPE}</div></div>{(b.mix||b.notes)&&<p className="text-sm text-gray-700 mt-2">{[b.mix,b.notes].filter(Boolean).join(" · ")}</p>}</div>))}</div></Section></>);}
function Workout({db,setDb}){const[date,setDate]=useState(todayISO());const[blocks,setBlocks]=useState([{type:"유산소",duration:30},{type:"상체",duration:30}]);const[rpe,setRpe]=useState(6);const[notes,setNotes]=useState("");const addBlock=()=>setBlocks([...blocks,{type:"","duration":0}]);const save=()=>{setDb({...db,workouts:[...db.workouts,{date,blocks,rpe:Number(rpe),notes}]});setBlocks([{type:"유산소",duration:30}]);setRpe(6);setNotes("")};return(<><Section title="운동 기록" subtitle="예: 유산소 30분 / 상체 30분"><Row><Input label="날짜" type="date" value={date} onChange={e=>setDate(e.target.value)}/><Input label="RPE(1-10)" type="number" value={rpe} onChange={e=>setRpe(e.target.value)}/></Row><div className="mt-2">{blocks.map((b,i)=>(<div key={i} className="grid grid-cols-12 gap-2 mb-2"><div className="col-span-7"><Input label="구분" placeholder="유산소/상체/하체/코어" value={b.type} onChange={e=>setBlocks(blocks.map((x,idx)=>(idx===i?{...x,type:e.target.value}:x)))}/></div><div className="col-span-5"><Input label="시간(분)" type="number" value={b.duration} onChange={e=>setBlocks(blocks.map((x,idx)=>(idx===i?{...x,duration:Number(e.target.value)}:x)))}/></div></div>))}<button onClick={addBlock} className="text-sm text-gray-600 underline">블록 추가</button></div><Textarea label="메모" value={notes} onChange={e=>setNotes(e.target.value)}/><div className="flex justify-end"><PillButton onClick={save}>저장</PillButton></div></Section><Section title="기록 목록"><div className="space-y-3">{db.workouts.slice().sort((a,b)=>a.date<b.date?1:-1).map((w,i)=>(<div key={i} className="bg-white border rounded-xl p-4"><div className="flex items-center justify-between"><div className="font-medium">{w.date}</div><div className="text-sm text-gray-500">RPE{w.rpe}</div></div><div className="mt-1 flex flex-wrap">{w.blocks.map((b,j)=>(<span key={j} className="inline-flex items-center text-xs bg-gray-100 text-gray-700 rounded-full px-2 py-1 mr-2 mb-2">{b.type}{b.duration?` ${b.duration}분`:""}</span>))}</div>{w.notes&&<p className="text-sm text-gray-700 mt-2">{w.notes}</p>}</div>))}</div></Section></>);}
function Report({db}){const totals=useMemo(()=>{const byDate={};db.bullpen.forEach(b=>{byDate[b.date]=byDate[b.date]||{bullpenPitches:0,workoutsMin:0,gamesPitches:0};byDate[b.date].bullpenPitches+=Number(b.totalPitches||0)});db.workouts.forEach(w=>{const mins=w.blocks.reduce((s,x)=>s+Number(x.duration||0),0);byDate[w.date]=byDate[w.date]||{bullpenPitches:0,workoutsMin:0,gamesPitches:0};byDate[w.date].workoutsMin+=mins});db.games.forEach(g=>{byDate[g.date]=byDate[g.date]||{bullpenPitches:0,workoutsMin:0,gamesPitches:0};byDate[g.date].gamesPitches+=Number(g.pitches||0)});return byDate},[db]);const rows=Object.entries(totals).sort((a,b)=>a[0]<b[0]?1:-1).map(([date,v])=>({date,...v}));return(<><Section title="일자별 합계" subtitle="불펜 투구수 / 운동 시간 / 경기 투구수"><div className="overflow-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-gray-600"><th className="py-2 pr-4">날짜</th><th className="py-2 pr-4">불펜(구)</th><th className="py-2 pr-4">운동(분)</th><th className="py-2 pr-4">경기(구)</th></tr></thead><tbody>{rows.map((r,i)=>(<tr key={i} className="border-t"><td className="py-2 pr-4">{r.date}</td><td className="py-2 pr-4">{r.bullpenPitches}</td><td className="py-2 pr-4">{r.workoutsMin}</td><td className="py-2 pr-4">{r.gamesPitches}</td></tr>))}</tbody></table></div></Section></>);}
